# ci.yml
#
# Goal:
# - Run automated checks on every push / pull request:
#   1) Install dependencies
#   2) Train model artifact (so tests and Docker build have the model)
#   3) Run pytest
#   4) Build Docker image (ensures Dockerfile stays valid)
#
# Why this matters for MLOps:
# - CI prevents regressions and ensures reproducibility.
# - Every change is validated the same way, on a clean machine.

name: CI

on:
  push:
  pull_request:

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      # Checkout repository code
      - name: Checkout
        uses: actions/checkout@v4

      # Install a specific Python version for consistency
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Create the model artifact in CI (models/model.joblib)
      # This mirrors what you do locally.
      - name: Train model artifact
        run: |
          python -m src.ml.train

      # Run tests
      - name: Run pytest
        run: |
          python -m pytest -q

  docker-build:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: test

    steps:
      # Checkout repository code
      - name: Checkout
        uses: actions/checkout@v4

      # Build Docker image (this validates the Dockerfile)
      # Note: We must have the model artifact in the build context.
      - name: Train model artifact for Docker context
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m src.ml.train

      - name: Build Docker image
        run: |
          docker build -t mlops-model-service:ci .
